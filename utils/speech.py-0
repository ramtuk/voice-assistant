import pyttsx3
import speech_recognition as sr
import sounddevice as sd
import numpy as np
import os

from config import Config
from .vosk_recognizer import VoskRecognizer
from .whisper_recognizer import WhisperRecognizer

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
vosk_recognizer = VoskRecognizer() if Config.RECOGNITION_TYPE == 'vosk' else None
whisper_recognizer = WhisperRecognizer() if Config.RECOGNITION_TYPE == 'whisper' else None

# –î–ª—è Google —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
recognizer = None
if Config.RECOGNITION_TYPE == 'google':
    recognizer = sr.Recognizer()

# TTS
try:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º espeak –¥—Ä–∞–π–≤–µ—Ä –∏ —É–∫–∞–∑—ã–≤–∞–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–≤–æ–¥–∞
    os.environ['ESPEAK_DATA_PATH'] = '/usr/share/espeak-data'
    tts_engine = pyttsx3.init(driverName='espeak')
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ–ª–æ—Å–∞
    voices = tts_engine.getProperty('voices')
    for voice in voices:
        if 'russian' in voice.name.lower() or 'ru' in voice.id.lower():
            tts_engine.setProperty('voice', voice.id)
            break
    
    tts_engine.setProperty('rate', Config.VOICE_RATE)
    tts_engine.setProperty('volume', Config.VOICE_VOLUME)
    
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TTS: {e}")
    tts_engine = None

def listen():
    """–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    if Config.RECOGNITION_TYPE == 'vosk' and vosk_recognizer:
        return vosk_recognizer.listen_vosk()
    elif Config.RECOGNITION_TYPE == 'whisper' and whisper_recognizer:
        return whisper_recognizer.listen_whisper()
    elif Config.RECOGNITION_TYPE == 'google':
        return listen_google()
    else:
        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {Config.RECOGNITION_TYPE}")
        return ""

def listen_google():
    """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ pyaudio"""
    try:
        print("üé§ –°–ª—É—à–∞—é (Google alternative)...")

        # –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ —Å –ø–æ–º–æ—â—å—é sounddevice
        sample_rate = 16000
        duration = 5  # seconds

        audio_data = sd.rec(int(duration * sample_rate),
                           samplerate=sample_rate,
                           channels=1,
                           dtype='int16',
                           device=0)  # USB MIC PRO
        sd.wait()

        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è speech_recognition
        audio_data_bytes = audio_data.flatten().tobytes()
        
        # –°–æ–∑–¥–∞–µ–º AudioData –æ–±—ä–µ–∫—Ç –¥–ª—è speech_recognition
        audio = sr.AudioData(audio_data_bytes, sample_rate, 2)

        try:
            query = recognizer.recognize_google(audio, language='ru-RU')
            print(f"üë§ –í—ã —Å–∫–∞–∑–∞–ª–∏: {query}")
            return query.lower()
        except sr.UnknownValueError:
            print("‚ùå –†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞")
            return ""
        except sr.RequestError as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ Google: {e}")
            return ""

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–∏: {e}")
        return ""

def say(text):
    """–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏"""
    print(f"ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {text}")
    
    if tts_engine:
        try:
            # –ü—Ä–æ—Å—Ç–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Ä–µ—á—å —á–µ—Ä–µ–∑ espeak
            tts_engine.say(text)
            tts_engine.runAndWait()
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏: {e}")
            # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - —Å–∏—Å—Ç–µ–º–Ω—ã–π espeak
            try:
                import subprocess
                subprocess.run(['espeak', '-v', 'russian', text], 
                             check=False, timeout=10)
            except:
                print("‚ö†Ô∏è  –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    else:
        print("‚ö†Ô∏è  –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")